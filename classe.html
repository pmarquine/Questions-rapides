<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Questions rapides – Classe</title>
<link rel="stylesheet" href="style.css">
<style>
h1{font-size:clamp(26px,4vw,48px);margin:20px 0;text-align:center;text-shadow:0 0 8px rgba(0,0,0,.4)}
.container{margin:0 auto;padding:20px;max-width:95%}
.back-btn{position:fixed;top:20px;left:20px;background:rgba(0,0,0,.25);color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:10px 18px;text-decoration:none;font-weight:600;font-size:16px;z-index:1000;transition:background .2s,border-color .2s,transform .06s}
.back-btn:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.35)}
.back-btn:active{transform:translateY(1px)}
.table-wrap{overflow-x:auto;margin-top:20px;border:1px solid rgba(255,255,255,.25);border-radius:12px;background:rgba(0,0,0,.15);padding:10px}
table{border-collapse:collapse;min-width:1800px;margin:0 auto}
td{border-right:1px solid rgba(255,255,255,.2);border-bottom:1px solid rgba(255,255,255,.2);padding:10px;text-align:center;min-width:54px;background:rgba(0,0,0,.08)}
a{color:#c4ffd1;text-decoration:none;font-weight:700}
td.done{background:rgba(17,43,22,.7)}
td.done a{color:#2ecc71}
h2{text-align:center;margin:6px 0 10px}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
  <a href="index.html" class="back-btn">⬅ Accueil</a>
  <div class="container">
    <h1 id="classTitle">Classe</h1>
    <div class="table-wrap" id="tableWrap"></div>
  </div>

<script>
// ======================================================================
//  Firebase – configuration
// ======================================================================
const firebaseConfig = {
  apiKey: "AIzaSyCXjYNdPZqQBEnswEo5yIHWjgFBwIpkYBY",
  authDomain: "questions-rapides.firebaseapp.com",
  databaseURL: "https://questions-rapides-default-rtdb.firebaseio.com",
  projectId: "questions-rapides",
  storageBucket: "questions-rapides.firebasestorage.app",
  messagingSenderId: "510854193536",
  appId: "1:510854193536:web:80857ccb52e8d695e02165",
  measurementId: "G-7NEPYDJ1Z0"
};

firebase.initializeApp(firebaseConfig);

// Même identifiant prof que dans index.html
const PROF_ID = "pmarquine";
const dbRoot = firebase.database().ref("qrData/" + PROF_ID);

// ======================================================================
//  Helpers
// ======================================================================
const STORAGE_PDFS = "qr_pdfs_index_v3";
const STORAGE_STATE_PREFIX = "qr_state_v3_";

function load(k, def=[]) {
  try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; }
  catch { return def; }
}

// Clé sûre pour Firebase (pas de . # $ [ ])
function safeFirebaseKey(str){
  const cleaned = str.replace(/[.#$/\[\]]/g,"_");
  return encodeURIComponent(cleaned);
}

// ======================================================================
//  Lecture paramètres URL
// ======================================================================
const params = new URLSearchParams(location.search);
const CLASS_NAME = params.get("c") || "Classe";
const LV_RAW = params.get("lv");
const CLASS_LV = Number.isFinite(parseInt(LV_RAW,10)) ? parseInt(LV_RAW,10) : null;

document.getElementById("classTitle").textContent = CLASS_NAME;

// ======================================================================
//  Déduction des niveaux depuis le nom de fichier
// ======================================================================
function inferLevelsFromName(filename){
  const m = filename && filename.match(/\(([^)]+)\)\.pdf$/i);
  if(!m) return [];
  return m[1].split(/\s+/).map(s=>parseInt(s,10)).filter(n=>[6,5,4,3].includes(n));
}

// ======================================================================
//  Chargement des PDFs
// ======================================================================
function loadPDFList(){
  const all = load(STORAGE_PDFS, []);

  return all.filter(p => {
    if (CLASS_LV === null) return true;

    const lvArr = (p.levels && p.levels.length ? p.levels : inferLevelsFromName(p.name)) || [];

    if (!lvArr.length) return true;
    return lvArr.includes(CLASS_LV);
  });
}

// ======================================================================
//  État cloud : chargement + sauvegarde d’un PDF
// ======================================================================

// Charge l’état d’un seul pdf dans cette classe
async function cloudLoadPDFState(pdfName){
  const key = STORAGE_STATE_PREFIX + CLASS_NAME + "_" + safeFirebaseKey(pdfName);
  try{
    const snap = await dbRoot.child("states").child(key).once("value");
    return snap.exists() ? snap.val() : null;
  }catch(e){
    console.warn("Cloud load error:", e);
    return null;
  }
}

// Sauvegarde l’état d’un seul pdf dans le cloud
async function cloudSavePDFState(pdfName, stateArray){
  const key = STORAGE_STATE_PREFIX + CLASS_NAME + "_" + safeFirebaseKey(pdfName);
  try{
    await dbRoot.child("states").child(key).set(JSON.stringify(stateArray));
  }catch(e){
    console.warn("Cloud save error:", e);
  }
}

// ======================================================================
//  Construction d’un tableau pour un PDF
// ======================================================================
async function buildRow(pdf){
  const maxQ = Math.min(100, Math.max(1, pdf.pages || 100));
  const table = document.createElement("table");
  const tr = document.createElement("tr");

  for(let i=1;i<=maxQ;i++){
    const td = document.createElement("td");
    td.dataset.q = i;
    const a = document.createElement("a");
    a.href = pdf.name + "#page=" + i;
    a.target = "_blank";
    a.textContent = "Q" + i;
    td.appendChild(a);
    tr.appendChild(td);
  }
  table.appendChild(tr);

  // --------------------- Charger l’état local -----------------------
  const stateKey = STORAGE_STATE_PREFIX + CLASS_NAME + "_" + safeFirebaseKey(pdf.name);
  let state = [];
  try{ state = JSON.parse(localStorage.getItem(stateKey)) || []; }catch{}

  // --------------------- Charger l’état cloud -----------------------
  const cloudStateStr = await cloudLoadPDFState(pdf.name);
  if (cloudStateStr){
    try{
      const cloudState = JSON.parse(cloudStateStr);
      if (Array.isArray(cloudState)){
        state = cloudState;
        localStorage.setItem(stateKey, JSON.stringify(state));
      }
    }catch{}
  }

  // --------------------- Appliquer le rendu -------------------------
  function apply(){
    for(let i=1;i<=maxQ;i++){
      const td = table.querySelector('td[data-q="'+i+'"]');
      if(!td) continue;
      td.classList.toggle("done", state.includes(i));
    }
  }
  apply();

  // --------------------- Gestion clic -------------------------------
  table.addEventListener("click", async ev=>{
    const td = ev.target.closest("td[data-q]");
    if(!td) return;

    const q = parseInt(td.dataset.q,10);
    if(state.includes(q)) state = state.filter(x=>x!==q);
    else state.push(q);

    // localStorage
    localStorage.setItem(stateKey, JSON.stringify(state));
    td.classList.toggle("done");

    // Sauvegarde cloud
    await cloudSavePDFState(pdf.name, state);
  });

  const wrap = document.createElement("div");
  wrap.className = "row-wrap";
  const title = document.createElement("h2");
  title.textContent = pdf.title || pdf.name.replace(/\s*\([^)]*\)\.pdf$/i,'').replace(/\.pdf$/i,'');
  wrap.appendChild(title);
  wrap.appendChild(table);
  return wrap;
}

// ======================================================================
//  Rendu de la page
// ======================================================================
async function render(){
  const mount = document.getElementById("tableWrap");
  const pdfs = loadPDFList();

  if(!pdfs.length){
    mount.innerHTML = "<p>Aucun PDF pour cette classe. Ajoute/scanne des PDF sur la page d’accueil.</p>";
    return;
  }

  // Tri par titre
  pdfs.sort((a,b)=> (a.title||"").localeCompare(b.title||"", "fr"));

  // Regroupement par titre
  const byTitle = new Map();
  for(const p of pdfs){
    const key = (p.title && p.title.trim())
             || p.name.replace(/\s*\([^)]*\)\.pdf$/i,'').replace(/\.pdf$/i,'');
    if(!byTitle.has(key)) byTitle.set(key, []);
    byTitle.get(key).push(p);
  }

  // Rendu
  for(const [title,list] of byTitle.entries()){
    for(const pdf of list){
      mount.appendChild(await buildRow(pdf));
    }
  }
}

// ======================================================================
//  INIT
// ======================================================================
render();

</script>
</body>
</html>
