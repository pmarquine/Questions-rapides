<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Questions rapides â€“ Accueil</title>
<link rel="stylesheet" href="style.css">

<style>
body{
  margin:0;
  background:#000;
  color:#f5f5f5;
  font-family: "Comic Sans MS","Segoe UI",system-ui,Arial,sans-serif;
}
h1{
  text-align:center;
  margin:24px 0 10px;
  font-size:clamp(28px,4vw,44px);
}
.section{
  max-width:1100px;
  margin:0 auto 24px;
  padding:16px;
}
.buttons{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}
button,a.btn{
  background:#1c1c1c;
  border:1px solid #2a2a2a;
  color:#fff;
  padding:12px;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  text-align:center;
  text-decoration:none;
}
button:hover,a.btn:hover{background:#262626}
.hidden{display:none}
.classes{
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  justify-content:center;
}
.class{
  padding:14px 20px;
  background:#1c1c1c;
  border-radius:14px;
  border:1px solid #2a2a2a;
  font-size:18px;
  text-decoration:none;
  color:#fff;
}
.note{
  text-align:center;
  color:#aaa;
  font-size:14px;
}
</style>
</head>

<body>

<h1>Questions rapides</h1>

<div class="section">
  <div class="buttons">
    <button id="btnAdd">â• Ajouter PDF</button>
    <button id="btnScan">ğŸ” Scanner PDF</button>
    <button id="btnReset">ğŸ§¹ Effacer coloriage</button>
    <button id="btnSave">ğŸ’¾ Sauvegarder</button>
    <button id="btnRestore">ğŸ“¥ Restaurer sauvegarde</button>
    <a class="btn" href="aide.html" target="_blank">â„¹ï¸ Aide</a>
  </div>

  <input type="file" id="fileAdd" accept=".pdf" multiple class="hidden">
  <input type="file" id="fileScan" accept=".pdf" multiple class="hidden">
  <input type="file" id="fileRestore" accept=".json" class="hidden">
</div>

<div class="section">
  <h2 style="text-align:center">Classes</h2>
  <div class="classes" id="classes"></div>
</div>

<div class="note">
  Fonctionne en ligne (GitHub Pages).  
  Progression enregistrÃ©e sur cet appareil.
</div>

<script>
const STORAGE_PDFS="qr_pdfs_v1";
const STORAGE_CLASSES="qr_classes_v1";

function load(k,d){try{return JSON.parse(localStorage.getItem(k))||d}catch{return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

const defaultClasses=[
  {name:"5ABI",lv:5},{name:"5J",lv:5},
  {name:"4B",lv:4},{name:"4J",lv:4},
  {name:"3D",lv:3},{name:"3I",lv:3}
];

if(!localStorage.getItem(STORAGE_CLASSES)) save(STORAGE_CLASSES,defaultClasses);

function renderClasses(){
  const div=document.getElementById("classes");
  div.innerHTML="";
  load(STORAGE_CLASSES,[]).forEach(c=>{
    const a=document.createElement("a");
    a.className="class";
    a.href=`classe.html?c=${encodeURIComponent(c.name)}&lv=${c.lv}`;
    a.textContent=c.name;
    div.appendChild(a);
  });
}

document.getElementById("btnAdd").onclick=()=>fileAdd.click();
fileAdd.onchange=e=>{
  const pdfs=load(STORAGE_PDFS,[]);
  [...e.target.files].forEach(f=>{
    if(!pdfs.find(p=>p.name===f.name)){
      pdfs.push({name:f.name,pages:null});
    }
  });
  save(STORAGE_PDFS,pdfs);
  alert("PDF ajoutÃ©s");
};

document.getElementById("btnScan").onclick=()=>fileScan.click();
fileScan.onchange=async e=>{
  const pdfs=load(STORAGE_PDFS,[]);
  for(const f of e.target.files){
    const buf=await f.arrayBuffer();
    const txt=new TextDecoder("latin1").decode(buf);
    const pages=(txt.match(/\/Type\s*\/Page\b/g)||[]).length;
    const p=pdfs.find(x=>x.name===f.name);
    if(p) p.pages=pages;
  }
  save(STORAGE_PDFS,pdfs);
  alert("Scan terminÃ©");
};

document.getElementById("btnReset").onclick=()=>{
  if(confirm("Effacer tous les coloriages ?")){
    Object.keys(localStorage).forEach(k=>{
      if(k.startsWith("qr_state_")) localStorage.removeItem(k);
    });
    alert("Coloriages effacÃ©s");
  }
};

document.getElementById("btnSave").onclick=()=>{
  const data={
    pdfs:load(STORAGE_PDFS,[]),
    classes:load(STORAGE_CLASSES,[]),
    state:Object.fromEntries(Object.entries(localStorage).filter(([k])=>k.startsWith("qr_state_")))
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="QR_backup.json";
  a.click();
};

document.getElementById("btnRestore").onclick=()=>fileRestore.click();
fileRestore.onchange=async e=>{
  const txt=await e.target.files[0].text();
  const data=JSON.parse(txt);
  save(STORAGE_PDFS,data.pdfs||[]);
  save(STORAGE_CLASSES,data.classes||[]);
  Object.keys(localStorage).forEach(k=>{if(k.startsWith("qr_state_"))localStorage.removeItem(k)});
  Object.entries(data.state||{}).forEach(([k,v])=>localStorage.setItem(k,v));
  alert("Sauvegarde restaurÃ©e");
  renderClasses();
};

renderClasses();
</script>
</body>
</html>
