<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Questions rapides ‚Äì Accueil</title>
<link rel="stylesheet" href="style.css">
<style>
:root{--bg:#000;--panel:#121212;--border:#2a2a2a;--text:#f5f5f5;--accent:#c4ffd1;--muted:#9aa3a2;--chip:#1c1c1c;--chip-border:#2a2a2a;--chip-hover:#232323;--bad:#d9534f;--good:#2ecc71}
*{box-sizing:border-box}html,body{height:100%}
@font-face{font-family:"Little Days Embedded";src:local("Little Days");font-display:swap}
body{margin:0;background:var(--bg);color:var(--text);font-family:"Little Days Embedded","Comic Sans MS","Segoe UI",system-ui,Arial,sans-serif;line-height:1.5}
h1{text-align:center;font-size:clamp(26px,3.6vw,40px);margin:24px 12px 16px;text-shadow:0 0 8px rgba(196,255,209,.35);letter-spacing:.5px}
.toolbar{max-width:1100px;margin:0 auto 20px;padding:10px 12px}
details.options{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden}
details.options summary{list-style:none;padding:14px 16px;cursor:pointer;display:flex;gap:10px;align-items:center;font-weight:600}
details.options[open] summary{border-bottom:1px solid var(--border)}
.opts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;padding:14px}
.btn{background:var(--chip);border:1px solid var(--chip-border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;text-align:center;transition:.15s}
.btn:hover{background:var(--chip-hover)}
.hidden{display:none}
.note{max-width:1100px;margin:12px auto 0;color:var(--muted);font-size:.92rem;text-align:center}
.classes{max-width:1100px;margin:10px auto 60px;display:flex;flex-wrap:wrap;gap:14px;justify-content:center}
.class-chip{background:var(--chip);border:1px solid var(--chip-border);padding:12px 18px;border-radius:14px;cursor:pointer;transition:.15s;font-weight:600;min-width:120px;text-align:center;color:var(--text);text-decoration:none}
.class-chip:hover{background:var(--chip-hover)}
.manager{padding:14px;border-top:1px dashed var(--border);background:#0f0f0f}
.manager h3{margin:4px 0 10px;font-size:18px}
.row{display:grid;grid-template-columns:1fr 110px 320px;gap:8px;align-items:center;margin-bottom:8px}
.row.header{color:var(--muted);font-weight:700}
input[type=text], select{background:#151515;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.btn.small{padding:8px 10px;border-radius:10px;font-size:14px}
.btn.danger{border-color:#3a1e1e;background:#221111}
.btn.danger:hover{background:#2b1515}
.btn.warn{border-color:#3a2a1e;background:#222011}
.btn.warn:hover{background:#302612}
.info{color:var(--muted);font-size:.85rem;margin:6px 0 0}
.sep{height:1px;background:var(--border);margin:10px 0}
</style>
</head>
<body>
  <h1>Questions rapides ‚Äì Accueil</h1>

  <div class="toolbar">
    <details class="options" open>
      <summary>‚öôÔ∏è Options</summary>
      <div class="opts-grid">
        <div>
          <button class="btn" id="btnAddPdfs">‚ûï Ajouter des PDF</button>
          <input id="fileAdd" type="file" accept=".pdf" multiple class="hidden">
        </div>

        <div>
          <button class="btn" id="btnScan">üîç Scanner les PDF (compter les pages)</button>
          <input id="fileScan" type="file" accept=".pdf" multiple class="hidden">
        </div>

        <div>
          <button class="btn" id="btnResetAll">üßπ Effacer coloriages ‚Äî toutes classes</button>
        </div>

        <div>
          <button class="btn" id="btnBackup">üíæ Sauvegarder (t√©l√©chargement)</button>
        </div>

        <div>
          <button class="btn" id="btnOverwrite">üíæ Sauvegarder (√©craser)</button>
        </div>

        <div>
          <button class="btn" id="btnRestore">üì• Restaurer une sauvegarde</button>
          <input id="fileRestore" type="file" accept=".json" class="hidden">
        </div>

        <div>
          <a class="btn" href="aide.html" target="_blank">‚ÑπÔ∏è Guide d‚Äôutilisation</a>
        </div>
      </div>

      <div class="note">
        Astuce : nomme les fichiers ainsi : <code>Titre (6 5 4).pdf</code><br>
        L‚Äôouverture utilise <code>#page=</code> (hors ligne ok).
      </div>

      <div class="manager" id="manager">
        <h3>üë• G√©rer les classes</h3>
        <div class="row header"><div>Nom</div><div>Niveau</div><div>Actions</div></div>
        <div id="rows"></div>
        <div class="sep"></div>
        <div class="row">
          <input type="text" id="newName" placeholder="Ex : 5ABI">
          <select id="newLevel">
            <option value="">‚Äî niveau ‚Äî</option>
            <option value="6">6e</option>
            <option value="5">5e</option>
            <option value="4">4e</option>
            <option value="3">3e</option>
          </select>
          <div class="actions">
            <button class="btn small" id="btnAdd">‚ûï Ajouter</button>
            <button class="btn small" id="btnClear">‚Ü∫ Vider</button>
          </div>
        </div>
        <div class="info">Jusqu‚Äô√† 20 classes. R√©glages m√©moris√©s localement.</div>
      </div>
    </details>
  </div>

  <div class="note">Choisis ta classe :</div>
  <div class="classes" id="classes"></div>

<script>
// === Gestion du stockage ===
const STORAGE_PDFS="qr_pdfs_index_v3", STORAGE_CLASSES="qr_classes_v3";
const $=s=>document.querySelector(s);
function load(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){return f}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

// === Classes par d√©faut ===
function ensureDefaults(){
  let arr = load(STORAGE_CLASSES,null);
  if(!arr){
    arr=[{name:"5ABI",level:5},{name:"5J",level:5},{name:"4B",level:4},{name:"4J",level:4},{name:"3D",level:3},{name:"3I",level:3}];
    save(STORAGE_CLASSES,arr);
  }
  return arr;
}
function renderClassChips(){
  const wrap=$("#classes"); wrap.innerHTML="";
  const classes = ensureDefaults();
  for(const c of classes){
    const a=document.createElement("a");
    a.className="class-chip";
    a.href=`classe.html?c=${encodeURIComponent(c.name)}&lv=${c.level||""}`;
    a.textContent=c.name;
    wrap.appendChild(a);
  }
}
function resetClassColoring(name){
  const prefix="qr_state_v3_"+encodeURIComponent(name)+"_";
  for(const k of Object.keys(localStorage)){
    if(k.startsWith(prefix)) localStorage.removeItem(k);
  }
}
function renderManager(){
  const rows=$("#rows"); rows.innerHTML="";
  const classes = ensureDefaults();
  classes.forEach((c,idx)=>{
    const row=document.createElement("div"); row.className="row";
    const name=document.createElement("input"); name.type="text"; name.value=c.name;
    const level=document.createElement("select");
    level.innerHTML=`<option value="">‚Äî</option><option value="6">6e</option><option value="5">5e</option><option value="4">4e</option><option value="3">3e</option>`;
    if([6,5,4,3].includes(c.level)) level.value=String(c.level);

    const acts=document.createElement("div"); acts.className="actions";
    const bSave=document.createElement("button"); bSave.className="btn small"; bSave.textContent="üíæ Enregistrer";
    bSave.onclick=()=>{
      const arr=ensureDefaults();
      const newName=name.value.trim()||c.name;
      if(newName!==c.name){
        const oldPref="qr_state_v3_"+encodeURIComponent(c.name)+"_";
        const newPref="qr_state_v3_"+encodeURIComponent(newName)+"_";
        for(const k of Object.keys(localStorage)){
          if(k.startsWith(oldPref)){
            const v=localStorage.getItem(k);
            localStorage.removeItem(k);
            const newKey = newPref + k.slice(oldPref.length);
            localStorage.setItem(newKey, v);
          }
        }
      }
      arr[idx]={name:newName,level:level.value?parseInt(level.value,10):null};
      save(STORAGE_CLASSES,arr);
      renderManager(); renderClassChips();
    };

    const bClr=document.createElement("button"); bClr.className="btn small warn"; bClr.textContent="üßπ Effacer coloriages";
    bClr.onclick=()=>{
      if(confirm(`Effacer les coloriages pour ${c.name} ?`)){
        resetClassColoring(c.name);
        alert(`Coloriages effac√©s pour ${c.name}.`);
      }
    };

    const bDel=document.createElement("button"); bDel.className="btn small danger"; bDel.textContent="üóëÔ∏è Supprimer";
    bDel.onclick=()=>{
      const arr=ensureDefaults();
      if(confirm(`Supprimer ${arr[idx].name} ? (les coloriages associ√©s seront effac√©s)`)){
        resetClassColoring(c.name);
        arr.splice(idx,1);
        save(STORAGE_CLASSES,arr);
        renderManager(); renderClassChips();
      }
    };

    acts.append(bSave,bClr,bDel);
    row.append(name,level,acts);
    rows.appendChild(row);
  });

  const arr=ensureDefaults();
  document.getElementById("btnAdd").disabled = arr.length>=20;
}

// === Parse titre + niveaux depuis le nom de fichier ===
function parseFromFilename(n){
  const title = n.replace(/\s*\([^)]*\)\.pdf$/i,"").replace(/\.pdf$/i,"").trim();
  const m = n.match(/\(([^)]+)\)\.pdf$/i);
  let levels=[];
  if(m){ levels=m[1].split(/\s+/).map(s=>parseInt(s,10)).filter(n=>[6,5,4,3].includes(n)); }
  return { title, levels };
}
function mergePdfIndex(base,extra){
  const map=new Map(base.map(x=>[x.name,x]));
  for(const e of extra){
    if(map.has(e.name)){
      const c=map.get(e.name);
      c.title=c.title||e.title;
      if(!c.levels?.length) c.levels=e.levels;
      if((!c.pages||c.pages<1)&&e.pages) c.pages=e.pages;
    } else map.set(e.name,e);
  }
  return Array.from(map.values()).sort((a,b)=>a.title.localeCompare(b.title,"fr"));
}

// === Ajouter / Scanner PDF ===
document.getElementById("btnAddPdfs").onclick=()=>document.getElementById("fileAdd").click();
document.getElementById("fileAdd").onchange=ev=>{
  const files=[...(ev.target.files||[])]; if(!files.length) return;
  const cur=load(STORAGE_PDFS,[]);
  const extras=files.map(f=>({name:f.name,pages:null,...parseFromFilename(f.name)}));
  save(STORAGE_PDFS, mergePdfIndex(cur,extras));
  alert("PDF ajout√©(s). (Scanner pour compter les pages si besoin)");
  ev.target.value="";
};

document.getElementById("btnScan").onclick=()=>document.getElementById("fileScan").click();
document.getElementById("fileScan").onchange=async ev=>{
  const files=[...(ev.target.files||[])]; if(!files.length) return;
  const map=new Map(load(STORAGE_PDFS,[]).map(x=>[x.name,x]));
  let updated=0, asked=0;
  for(const f of files){
    const buf=await f.arrayBuffer();
    const txt=new TextDecoder("latin1").decode(buf);
    const m=txt.match(/\/Type\s*\/Page\b/g);
    let pages = m?.length || null;
    const item=map.get(f.name)||{name:f.name,...parseFromFilename(f.name)};
    if(!pages){
      const man=prompt(`Impossible de compter automatiquement : ${f.name}\nNombre de pages ?`);
      if(man){ const p=parseInt(man,10); if(p>0){item.pages=p;asked++;} }
    } else { item.pages=pages; updated++; }
    map.set(f.name,item);
  }
  save(STORAGE_PDFS, Array.from(map.values()));
  alert(`Comptage termin√©. Automatique : ${updated} ‚Äî Saisi : ${asked}`);
  ev.target.value="";
};

// === Assemblage des donn√©es √† sauvegarder ===
function makePayload(){
  const classes = load(STORAGE_CLASSES,[]);
  const pdfs = load(STORAGE_PDFS,[]);
  const states = {};
  for(const k of Object.keys(localStorage)){
    if(k.startsWith("qr_state_v3_")){
      states[k] = localStorage.getItem(k);
    }
  }
  return {
    meta: { app:"QuestionsRapides", version:3, savedAt:new Date().toISOString() },
    classes, pdfs, states
  };
}

// === Export iPad-friendly ===
// Sur iPad/Chrome, on ne peut PAS √©crire directement dans un fichier existant.
// Donc : on partage / enregistre "QR_backup.json" et iPadOS propose "Remplacer".
async function exportBackup(filename){
  const payload = makePayload();
  const json = JSON.stringify(payload,null,2);

  try{
    const file = new File([json], filename, {type:"application/json"});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ files:[file], title: filename, text: "Sauvegarde Questions Rapides" });
      return;
    }
  }catch(e){
    // fallback ci-dessous
  }

  const blob = new Blob([json], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}

// === Boutons sauvegarde ===
document.getElementById("btnBackup").onclick = ()=> exportBackup("QR_backup.json");
// "√âcraser" = m√™me nom + iPadOS propose Remplacer
document.getElementById("btnOverwrite").onclick = ()=> exportBackup("QR_backup.json");

// === Restaurer (import JSON) ===
document.getElementById("btnRestore").onclick=()=>document.getElementById("fileRestore").click();
document.getElementById("fileRestore").onchange=async ev=>{
  const f = ev.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const data = JSON.parse(text);
    if(!data || !data.meta || data.meta.app!=="QuestionsRapides"){
      alert("Fichier incompatible.");
      ev.target.value=""; return;
    }
    if(Array.isArray(data.classes)) save(STORAGE_CLASSES, data.classes);
    if(Array.isArray(data.pdfs))    save(STORAGE_PDFS, data.pdfs);
    for(const k of Object.keys(localStorage)){
      if(k.startsWith("qr_state_v3_")) localStorage.removeItem(k);
    }
    if(data.states && typeof data.states==="object"){
      for(const [k,v] of Object.entries(data.states)){
        if(k.startsWith("qr_state_v3_")) localStorage.setItem(k, v);
      }
    }
    alert("Sauvegarde restaur√©e ‚úÖ");
    renderManager(); renderClassChips();
  }catch(e){
    console.error(e);
    alert("Impossible de lire ce fichier de sauvegarde.");
  }finally{
    ev.target.value="";
  }
};

// === Reset total ===
document.getElementById("btnResetAll").onclick=()=>{
  if(!confirm("Effacer TOUS les coloriages (toutes classes) ?")) return;
  const arr=ensureDefaults();
  for(const c of arr){
    const prefix="qr_state_v3_"+encodeURIComponent(c.name)+"_";
    for(const k of Object.keys(localStorage)){
      if(k.startsWith(prefix)) localStorage.removeItem(k);
    }
  }
  alert("Coloriages effac√©s pour toutes les classes.");
};

// === Manager add/clear ===
document.getElementById("btnAdd").onclick=()=>{
  const name=document.getElementById("newName").value.trim();
  const lv=document.getElementById("newLevel").value?parseInt(document.getElementById("newLevel").value,10):null;
  if(!name){alert("Nom de classe requis.");return;}
  const arr=ensureDefaults();
  if(arr.length>=20){alert("Limite de 20 classes atteinte.");return;}
  if(arr.some(x=>x.name.toLowerCase()===name.toLowerCase())){alert("Cette classe existe d√©j√†.");return;}
  arr.push({name,level:lv});
  save(STORAGE_CLASSES,arr);
  document.getElementById("newName").value=""; document.getElementById("newLevel").value="";
  renderManager(); renderClassChips();
};
document.getElementById("btnClear").onclick=()=>{document.getElementById("newName").value=""; document.getElementById("newLevel").value="";};

// === Init ===
renderManager(); renderClassChips();
</script>
</body>
</html>
