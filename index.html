<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Questions rapides ‚Äì Accueil</title>
<link rel="stylesheet" href="style.css">
<style>
  :root{--bg:#000;--panel:#111;--border:#2a2a2a;--text:#f5f5f5;--muted:#a7a7a7;--btn:#1b1b1b;--btn2:#232323}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Arial,sans-serif}
  h1{margin:22px 12px 10px;text-align:center;font-size:clamp(26px,3.6vw,44px)}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .btn,a.btn{display:block;width:100%;background:var(--btn);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;text-align:center;text-decoration:none;cursor:pointer;font-weight:650}
  .btn:hover,a.btn:hover{background:var(--btn2)}
  .note{color:var(--muted);font-size:14px;margin-top:10px;text-align:center;line-height:1.4}
  .classes{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:16px}
  .chip{background:var(--btn);border:1px solid var(--border);border-radius:14px;padding:12px 18px;color:var(--text);text-decoration:none;font-weight:750}
  .chip:hover{background:var(--btn2)}
  details{margin-top:14px}
  summary{cursor:pointer;font-weight:800}
  .row{display:grid;grid-template-columns:1fr 110px 320px;gap:8px;align-items:center;margin:8px 0}
  .row.header{color:var(--muted);font-weight:800}
  input[type=text],select{width:100%;background:#151515;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px;font-size:16px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .small{padding:10px;border-radius:12px;font-size:14px}
  .danger{border-color:#3a1e1e;background:#221111}
  .danger:hover{background:#2b1515}
  .warn{border-color:#3a2a1e;background:#222011}
  .warn:hover{background:#302612}
  .sep{height:1px;background:var(--border);margin:10px 0}
</style>
</head>

<body>
<h1>Questions rapides</h1>

<div class="wrap">
  <div class="panel">
    <div class="grid">
      <button class="btn" id="btnRefresh">üîÑ Actualiser la liste des PDF (GitHub)</button>
      <button class="btn warn" id="btnResetAll">üßπ Effacer coloriages (tout)</button>
      <button class="btn" id="btnBackup">üíæ Sauvegarder (JSON)</button>
      <button class="btn" id="btnRestore">üì• Restaurer sauvegarde</button>
      <a class="btn" href="aide.html" target="_blank">‚ÑπÔ∏è Aide</a>
    </div>

    <input id="fileRestore" type="file" accept=".json" style="display:none">

    <div class="note">
      Les PDF sont servis depuis GitHub : dossier <code>pdf/</code> + liste <code>pdfs.json</code>.<br>
      Tri auto par niveau via le suffixe : <code>(5 4)</code>, <code>(3)</code>, etc.
    </div>

    <details open>
      <summary>üë• G√©rer les classes (ajouter / modifier / supprimer)</summary>

      <div class="row header">
        <div>Nom</div><div>Niveau</div><div>Actions</div>
      </div>
      <div id="rows"></div>

      <div class="sep"></div>

      <div class="row">
        <input id="newName" type="text" placeholder="Ex : 5ABI">
        <select id="newLevel">
          <option value="">‚Äî niveau ‚Äî</option>
          <option value="6">6e</option>
          <option value="5">5e</option>
          <option value="4">4e</option>
          <option value="3">3e</option>
        </select>
        <div class="actions">
          <button class="btn small" id="btnAddClass">‚ûï Ajouter</button>
          <button class="btn small" id="btnClearClass">‚Ü∫ Vider</button>
        </div>
      </div>
    </details>
  </div>

  <div class="note" style="margin-top:14px">Choisis une classe :</div>
  <div class="classes" id="classes"></div>
</div>

<script>
const STORAGE_PDFS    = "qr_pdfs_index_v3";
const STORAGE_CLASSES = "qr_classes_v3";
const STATE_PREFIX    = "qr_state_v3_";

const $ = s => document.querySelector(s);
function load(k, def){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch{ return def; } }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

function ensureDefaults(){
  let classes = load(STORAGE_CLASSES, null);
  if(!classes){
    classes = [
      {name:"5ABI", level:5},{name:"5J", level:5},
      {name:"4B", level:4},{name:"4J", level:4},
      {name:"3D", level:3},{name:"3I", level:3}
    ];
    save(STORAGE_CLASSES, classes);
  }
  return classes;
}

function inferLevelsFromFilename(filename){
  const m = filename.match(/\(([^)]+)\)\.pdf$/i);
  if(!m) return [];
  return m[1].trim().split(/\s+/).map(x=>parseInt(x,10)).filter(n=>[6,5,4,3].includes(n));
}
function parseTitle(filename){
  return filename.replace(/\s*\([^)]*\)\.pdf$/i,"").replace(/\.pdf$/i,"").trim();
}

function renderClassChips(){
  const wrap=$("#classes"); wrap.innerHTML="";
  for(const c of ensureDefaults()){
    const lv = [6,5,4,3].includes(c.level) ? c.level : "";
    const a=document.createElement("a");
    a.className="chip";
    a.href=`classe.html?c=${encodeURIComponent(c.name)}&lv=${encodeURIComponent(lv)}`;
    a.textContent=c.name + (lv?` (${lv}e)`:"");
    wrap.appendChild(a);
  }
}

function resetClassStates(className){
  const prefix = STATE_PREFIX + encodeURIComponent(className) + "_";
  for(const k of Object.keys(localStorage)){
    if(k.startsWith(prefix)) localStorage.removeItem(k);
  }
}

function renderManager(){
  const rows=$("#rows"); rows.innerHTML="";
  const classes=ensureDefaults();

  classes.forEach((c,idx)=>{
    const row=document.createElement("div"); row.className="row";

    const name=document.createElement("input");
    name.type="text"; name.value=c.name;

    const level=document.createElement("select");
    level.innerHTML=`
      <option value="">‚Äî</option>
      <option value="6">6e</option>
      <option value="5">5e</option>
      <option value="4">4e</option>
      <option value="3">3e</option>`;
    if([6,5,4,3].includes(c.level)) level.value=String(c.level);

    const acts=document.createElement("div"); acts.className="actions";

    const bSave=document.createElement("button");
    bSave.className="btn small";
    bSave.textContent="üíæ Enregistrer";
    bSave.onclick=()=>{
      const arr=ensureDefaults();
      const oldName=c.name;
      const newName=name.value.trim()||oldName;

      if(newName!==oldName){
        const oldPref=STATE_PREFIX+encodeURIComponent(oldName)+"_";
        const newPref=STATE_PREFIX+encodeURIComponent(newName)+"_";
        for(const k of Object.keys(localStorage)){
          if(k.startsWith(oldPref)){
            const v=localStorage.getItem(k);
            localStorage.removeItem(k);
            localStorage.setItem(newPref + k.slice(oldPref.length), v);
          }
        }
      }

      arr[idx]={name:newName, level: level.value?parseInt(level.value,10):null};
      save(STORAGE_CLASSES,arr);
      renderManager(); renderClassChips();
    };

    const bClr=document.createElement("button");
    bClr.className="btn small warn";
    bClr.textContent="üßπ Effacer coloriages";
    bClr.onclick=()=>{
      if(confirm(`Effacer les coloriages pour ${c.name} ?`)){
        resetClassStates(c.name);
        alert("OK");
      }
    };

    const bDel=document.createElement("button");
    bDel.className="btn small danger";
    bDel.textContent="üóëÔ∏è Supprimer";
    bDel.onclick=()=>{
      if(confirm(`Supprimer la classe ${c.name} ? (coloriages effac√©s)`)){
        const arr=ensureDefaults();
        resetClassStates(c.name);
        arr.splice(idx,1);
        save(STORAGE_CLASSES,arr);
        renderManager(); renderClassChips();
      }
    };

    acts.append(bSave,bClr,bDel);
    row.append(name,level,acts);
    rows.appendChild(row);
  });
}

/* ===== Charger les PDF depuis GitHub (pdfs.json) ===== */
async function refreshPdfs(){
  try{
    // anti-cache simple (utile sur iPad)
    const res = await fetch("./pdfs.json?ts=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP " + res.status);
    const list = await res.json();
    if(!Array.isArray(list)) throw new Error("pdfs.json invalide");

    const normalized = list.map(item=>{
      const name = String(item.name || "").trim();
      if(!name) return null;
      const pages = Number.isFinite(+item.pages) ? Math.max(1, parseInt(item.pages,10)) : null;
      const levels = Array.isArray(item.levels) ? item.levels : inferLevelsFromFilename(name);
      const title = item.title ? String(item.title) : parseTitle(name);
      return {name, pages, levels, title};
    }).filter(Boolean);

    save(STORAGE_PDFS, normalized);
    alert(`Liste PDF charg√©e ‚úÖ (${normalized.length})`);
  }catch(e){
    console.error(e);
    alert("Impossible de charger pdfs.json. V√©rifie qu‚Äôil est √† la racine du d√©p√¥t.");
  }
}

$("#btnRefresh").onclick = refreshPdfs;

/* ===== Sauvegarde / restauration (v3) ===== */
function makePayload(){
  const classes = load(STORAGE_CLASSES, []);
  const pdfs    = load(STORAGE_PDFS, []);
  const states  = {};
  for(const k of Object.keys(localStorage)){
    if(k.startsWith(STATE_PREFIX)) states[k] = localStorage.getItem(k);
  }
  return { meta:{app:"QuestionsRapides",version:3,savedAt:new Date().toISOString()}, classes, pdfs, states };
}

$("#btnBackup").onclick=()=>{
  const blob=new Blob([JSON.stringify(makePayload(),null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="QR_backup.json";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
};

$("#btnRestore").onclick=()=>$("#fileRestore").click();
$("#fileRestore").onchange=async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  try{
    const data = JSON.parse(await f.text());
    if(!data?.meta || data.meta.app!=="QuestionsRapides") throw new Error("bad");
    if(Array.isArray(data.classes)) save(STORAGE_CLASSES, data.classes);
    if(Array.isArray(data.pdfs))    save(STORAGE_PDFS, data.pdfs);

    for(const k of Object.keys(localStorage)){
      if(k.startsWith(STATE_PREFIX)) localStorage.removeItem(k);
    }
    if(data.states && typeof data.states==="object"){
      for(const [k,v] of Object.entries(data.states)){
        if(k.startsWith(STATE_PREFIX)) localStorage.setItem(k, v);
      }
    }
    alert("Restaur√© ‚úÖ");
    renderManager(); renderClassChips();
  }catch{
    alert("Sauvegarde incompatible.");
  }finally{
    ev.target.value="";
  }
};

$("#btnResetAll").onclick=()=>{
  if(!confirm("Effacer TOUS les coloriages ?")) return;
  for(const k of Object.keys(localStorage)){
    if(k.startsWith(STATE_PREFIX)) localStorage.removeItem(k);
  }
  alert("OK");
};

/* Ajouter classe */
$("#btnAddClass").onclick=()=>{
  const name=$("#newName").value.trim();
  const lv=$("#newLevel").value ? parseInt($("#newLevel").value,10) : null;
  if(!name) return alert("Nom requis");
  const arr=ensureDefaults();
  if(arr.some(x=>x.name.toLowerCase()===name.toLowerCase())) return alert("D√©j√† existante");
  arr.push({name, level:lv});
  save(STORAGE_CLASSES,arr);
  $("#newName").value=""; $("#newLevel").value="";
  renderManager(); renderClassChips();
};
$("#btnClearClass").onclick=()=>{ $("#newName").value=""; $("#newLevel").value=""; };

/* Init */
ensureDefaults();
renderManager();
renderClassChips();

// Optionnel : auto-charger pdfs.json au premier lancement si aucune liste
if(load(STORAGE_PDFS, []).length===0){
  // d√©commente si tu veux charger automatiquement sans bouton :
  // refreshPdfs();
}
</script>
</body>
</html>
